---
title: "50Hz or 60Hz?"
date: 2014-05-17T22:28:11+08:00
showDate: true
draft: false
---

In my second job as a 'software engineer', my job was, mainly maintain and update existing firmwares. 

I came across with a coffee machine that needs to be selling globally, rather than only some counties. My task was to update the part of the circuit and firmware that detects the AC main switching frequency.

##### Hardware
A non-zero-crossing Triac and an optocoupler were chosen as the detection circuit. The MCU input pin is protected from high voltage by the optocoupler. Whenever the AC signal crossing the zero, a small signal is output from the triac. A transistor will then amplify the pulses before feed in to the external interrupt pin of MCU.

##### Software
Whenever the machine boot, the timer for input capture will be initialised first. Then it counts the external pulses from the pin.

After a window of sampling time, 50Hz or 60Hz will be determinded by the average of captured period (i.e. 1/f) of the frequency. Once the AC main frequency is known, the software then utilize it to help on some non-time-critical tasks such as button press or brightness control.

##### AC line fail...
A unstable AC frequency protection was also added in this firmware update. The logic is that, when the AC frequency failed alternating certain times continuously, machine will enter a protection mode, just like sleep mode. All the state will be saved, all MCU peripherals will be stopped. 

In order to protect the motor and other behaviours, machine will only allow to exit this mode if user re-plug the power cord.